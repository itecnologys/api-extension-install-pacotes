# Arquitetura do Projeto - Carbonio + Traefik + pfSense

## Diagrama de Arquitetura

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                           INTERNET / EXTERNO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                    â”‚
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   IP PÃºblico: 95.216.14.146   â”‚
                    â”‚   (Hetzner - Servidor Proxmox)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    PFSENSE                               â”‚
                    â”‚              (Firewall/Gateway)                          â”‚
                    â”‚                                                           â”‚
                    â”‚  IP WAN: 10.0.0.2 (externa)                             â”‚
                    â”‚  IP LAN: 10.10.10.1 (gateway interno)                   â”‚
                    â”‚                                                           â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚  PORT FORWARDS (NAT):                            â”‚   â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 80  â†’ Traefik (10.10.10.105:8055) â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 443 â†’ Traefik (10.10.10.105:9055) â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 25  â†’ Carbonio (10.10.10.108:25)  â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 465 â†’ Carbonio (10.10.10.108:465) â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 587 â†’ Carbonio (10.10.10.108:587) â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 993 â†’ Carbonio (10.10.10.108:993) â”‚   â”‚   â”‚
                    â”‚  â”‚  â”‚ Porta 995 â†’ Carbonio (10.10.10.108:995) â”‚   â”‚   â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
                    â”‚  â”‚                                                    â”‚   â”‚
                    â”‚  â”‚  FIREWALL RULES:                                  â”‚   â”‚
                    â”‚  â”‚  - WAN: Allow 80, 443, 25, 465, 587, 993, 995   â”‚   â”‚
                    â”‚  â”‚  - LAN: Permitir trÃ¡fego interno                  â”‚   â”‚
                    â”‚  â”‚                                                    â”‚   â”‚
                    â”‚  â”‚  SNORT (IDS/IPS):                                 â”‚   â”‚
                    â”‚  â”‚  - Monitora trÃ¡fego WAN e LAN                     â”‚   â”‚
                    â”‚  â”‚  - Pass List: SNORT_TRUSTED_IPS                   â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ Rede Interna: 10.10.10.0/24
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   VM 105 - TRAEFIK    â”‚                    â”‚  VM 108 - CARBONIO   â”‚
        â”‚                       â”‚                    â”‚                       â”‚
        â”‚  IP: 10.10.10.105     â”‚                    â”‚  IP: 10.10.10.108    â”‚
        â”‚  Hostname: traefik     â”‚                    â”‚  Hostname:           â”‚
        â”‚                       â”‚                    â”‚  mail.ligbox.com.br  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚                       â”‚
        â”‚  â”‚  Docker         â”‚  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚  Container:     â”‚  â”‚                    â”‚  â”‚  Carbonio CE    â”‚ â”‚
        â”‚  â”‚  traefik:v3.6   â”‚  â”‚                    â”‚  â”‚  (Email Server) â”‚ â”‚
        â”‚  â”‚                 â”‚  â”‚                    â”‚  â”‚                 â”‚ â”‚
        â”‚  â”‚  Portas:        â”‚  â”‚                    â”‚  â”‚  Portas:        â”‚ â”‚
        â”‚  â”‚  - 8055 (HTTP)  â”‚  â”‚                    â”‚  â”‚  - 80 (HTTP)    â”‚ â”‚
        â”‚  â”‚  - 9055 (HTTPS) â”‚  â”‚                    â”‚  â”‚  - 443 (HTTPS)  â”‚ â”‚
        â”‚  â”‚                 â”‚  â”‚                    â”‚  â”‚  - 25 (SMTP)    â”‚ â”‚
        â”‚  â”‚  FunÃ§Ãµes:       â”‚  â”‚                    â”‚  â”‚  - 465 (SMTPS)  â”‚ â”‚
        â”‚  â”‚  - Reverse Proxyâ”‚  â”‚                    â”‚  â”‚  - 587 (SMTP-TLSâ”‚ â”‚
        â”‚  â”‚  - SSL/TLS      â”‚  â”‚                    â”‚  â”‚  - 993 (IMAPS)  â”‚ â”‚
        â”‚  â”‚  - Let's Encryptâ”‚  â”‚                    â”‚  â”‚  - 995 (POP3S)  â”‚ â”‚
        â”‚  â”‚  - Load Balancerâ”‚  â”‚                    â”‚  â”‚                 â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â”‚  ServiÃ§os:      â”‚ â”‚
        â”‚                       â”‚                    â”‚  â”‚  - Webmail      â”‚ â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                    â”‚  â”‚  - SMTP Server  â”‚ â”‚
        â”‚  â”‚  Roteamento:    â”‚  â”‚                    â”‚  â”‚  - IMAP Server  â”‚ â”‚
        â”‚  â”‚                 â”‚  â”‚                    â”‚  â”‚  - POP3 Server  â”‚ â”‚
        â”‚  â”‚  mail.ligbox... â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚  - CalDAV       â”‚ â”‚
        â”‚  â”‚    â†’ 10.10.10.  â”‚  â”‚                    â”‚  â”‚  - CardDAV      â”‚ â”‚
        â”‚  â”‚      108:443    â”‚  â”‚                    â”‚  â”‚  - ActiveSync   â”‚ â”‚
        â”‚  â”‚                 â”‚  â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â”‚  â”‚  proxy.itecno...â”‚  â”‚                    â”‚                       â”‚
        â”‚  â”‚    â†’ Dashboard  â”‚  â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                    â”‚  â”‚  NGINX          â”‚ â”‚
        â”‚                       â”‚                    â”‚  â”‚  (Web Server)   â”‚ â”‚
        â”‚                       â”‚                    â”‚  â”‚  - Escuta 443   â”‚ â”‚
        â”‚                       â”‚                    â”‚  â”‚  - SSL/TLS      â”‚ â”‚
        â”‚                       â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Fluxo de TrÃ¡fego Detalhado

### 1. TrÃ¡fego Web (HTTP/HTTPS)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚
â”‚  Externo    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HTTPS (443) ou HTTP (80)
       â”‚ mail.ligbox.com.br
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INTERNET â†’ IP PÃºblico: 95.216.14.146                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PFSENSE (Firewall)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Port Forward:                                         â”‚ â”‚
â”‚  â”‚  443 externa â†’ 10.10.10.105:9055 (Traefik)           â”‚ â”‚
â”‚  â”‚  80 externa  â†’ 10.10.10.105:8055 (Traefik)           â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ Firewall Rule: Allow WAN â†’ 443, 80                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Rede Interna (10.10.10.0/24)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TRAEFIK (VM 105)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Recebe: https://mail.ligbox.com.br:9055               â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ Processa:                                              â”‚ â”‚
â”‚  â”‚  - Verifica certificado SSL (Let's Encrypt)           â”‚ â”‚
â”‚  â”‚  - Roteia baseado em Host header                      â”‚ â”‚
â”‚  â”‚  - Aplica regras de redirecionamento                  â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ Encaminha para:                                        â”‚ â”‚
â”‚  â”‚  â†’ https://10.10.10.108:443 (Carbonio)                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ConexÃ£o HTTPS interna
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CARBONIO (VM 108)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ NGINX escuta em: 443                                   â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚ Responde:                                              â”‚ â”‚
â”‚  â”‚  - Webmail interface                                   â”‚ â”‚
â”‚  â”‚  - API endpoints                                       â”‚ â”‚
â”‚  â”‚  - Static files                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. TrÃ¡fego de Email (SMTP/IMAP/POP3)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cliente   â”‚
â”‚  Email      â”‚
â”‚  (Outlook,  â”‚
â”‚   Thunderbird)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ SMTP (25, 465, 587)
       â”‚ IMAP (993) / POP3 (995)
       â”‚ mail.ligbox.com.br
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INTERNET â†’ IP PÃºblico: 95.216.14.146                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PFSENSE (Firewall)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Port Forward:                                         â”‚ â”‚
â”‚  â”‚  25  â†’ 10.10.10.108:25  (SMTP)                        â”‚ â”‚
â”‚  â”‚  465 â†’ 10.10.10.108:465 (SMTPS)                       â”‚ â”‚
â”‚  â”‚  587 â†’ 10.10.10.108:587 (SMTP-TLS)                    â”‚ â”‚
â”‚  â”‚  993 â†’ 10.10.10.108:993 (IMAPS)                       â”‚ â”‚
â”‚  â”‚  995 â†’ 10.10.10.108:995 (POP3S)                       â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ âš ï¸  IMPORTANTE: Email vai DIRETO para Carbonio        â”‚ â”‚
â”‚  â”‚    (NÃƒO passa pelo Traefik!)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Rede Interna (10.10.10.0/24)
       â”‚ ConexÃ£o direta (bypass Traefik)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CARBONIO (VM 108)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ServiÃ§os de Email:                                     â”‚ â”‚
â”‚  â”‚  - SMTP Server (porta 25, 465, 587)                   â”‚ â”‚
â”‚  â”‚  - IMAP Server (porta 993)                            â”‚ â”‚
â”‚  â”‚  - POP3 Server (porta 995)                            â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚ Processa:                                              â”‚ â”‚
â”‚  â”‚  - AutenticaÃ§Ã£o                                        â”‚ â”‚
â”‚  â”‚  - Envio de emails                                     â”‚ â”‚
â”‚  â”‚  - Recebimento de emails                              â”‚ â”‚
â”‚  â”‚  - SincronizaÃ§Ã£o (CalDAV/CardDAV)                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Componentes e Responsabilidades

### ğŸ”¥ pfSense (Firewall/Gateway)
- **IP WAN**: 10.0.0.2 (externa)
- **IP LAN**: 10.10.10.1 (gateway)
- **FunÃ§Ãµes**:
  - âœ… Firewall (regras de entrada/saÃ­da)
  - âœ… NAT / Port Forwarding
  - âœ… Gateway para rede interna
  - âœ… Snort (IDS/IPS) - monitoramento de seguranÃ§a
  - âœ… DHCP (opcional)
  - âœ… DNS (opcional)

### ğŸ³ Traefik (VM 105 - Reverse Proxy)
- **IP**: 10.10.10.105
- **Portas**: 8055 (HTTP), 9055 (HTTPS)
- **FunÃ§Ãµes**:
  - âœ… Reverse Proxy para trÃ¡fego web
  - âœ… SSL/TLS termination
  - âœ… Gerenciamento automÃ¡tico de certificados (Let's Encrypt)
  - âœ… Roteamento baseado em Host header
  - âœ… Load balancing (se necessÃ¡rio)
  - âœ… Redirecionamento HTTP â†’ HTTPS

### ğŸ“§ Carbonio (VM 108 - Email Server)
- **IP**: 10.10.10.108
- **Hostname**: mail.ligbox.com.br
- **Portas**:
  - Web: 80, 443
  - Email: 25, 465, 587, 993, 995
- **FunÃ§Ãµes**:
  - âœ… Servidor de email completo (SMTP/IMAP/POP3)
  - âœ… Webmail interface
  - âœ… CalDAV (calendÃ¡rio)
  - âœ… CardDAV (contatos)
  - âœ… ActiveSync
  - âœ… NGINX como web server

## Regras de Roteamento

### TrÃ¡fego Web â†’ Via Traefik
```
Internet â†’ pfSense:443 â†’ Traefik:9055 â†’ Carbonio:443
Internet â†’ pfSense:80  â†’ Traefik:8055 â†’ Carbonio:443 (redirecionado)
```

### TrÃ¡fego Email â†’ Direto para Carbonio
```
Internet â†’ pfSense:25  â†’ Carbonio:25  (SMTP)
Internet â†’ pfSense:465 â†’ Carbonio:465 (SMTPS)
Internet â†’ pfSense:587 â†’ Carbonio:587 (SMTP-TLS)
Internet â†’ pfSense:993 â†’ Carbonio:993 (IMAPS)
Internet â†’ pfSense:995 â†’ Carbonio:995 (POP3S)
```

## SeguranÃ§a (Snort)

### Whitelist Configurada
- **Alias**: `SNORT_TRUSTED_IPS`
- **IPs incluÃ­dos**:
  - 10.10.10.105/32 (Traefik)
  - 10.10.10.108/32 (Carbonio)
  - 51.171.219.218/20 (IP local Cursor/IDE)
  - 95.216.14.0/24 (Range Hetzner)
  - Ranges Cloudflare (15 ranges)

### Pass List
- **Nome**: `SSH_Cloudflare_Hetzner_Whitelist` ou `Traefik_Carbonio_Whitelist`
- **Associada a**: Todas as interfaces do Snort (WAN, LAN)
- **FunÃ§Ã£o**: Evitar bloqueios de IPs confiÃ¡veis

## Portas e Protocolos

| Porta | Protocolo | ServiÃ§o | Destino | Via Traefik? |
|-------|-----------|---------|---------|--------------|
| 80 | HTTP | Web | Traefik:8055 â†’ Carbonio | âœ… Sim |
| 443 | HTTPS | Web | Traefik:9055 â†’ Carbonio | âœ… Sim |
| 25 | SMTP | Email | Carbonio:25 | âŒ NÃ£o |
| 465 | SMTPS | Email Seguro | Carbonio:465 | âŒ NÃ£o |
| 587 | SMTP-TLS | Email Submission | Carbonio:587 | âŒ NÃ£o |
| 993 | IMAPS | IMAP Seguro | Carbonio:993 | âŒ NÃ£o |
| 995 | POP3S | POP3 Seguro | Carbonio:995 | âŒ NÃ£o |

## BenefÃ­cios da Arquitetura

1. **SeparaÃ§Ã£o de Responsabilidades**:
   - Traefik cuida apenas de trÃ¡fego web
   - Carbonio cuida apenas de email
   - pfSense cuida de seguranÃ§a e roteamento

2. **Performance**:
   - Email nÃ£o passa pelo Traefik (menos latÃªncia)
   - Traefik otimizado para SSL/TLS termination

3. **SeguranÃ§a**:
   - Snort monitora todo trÃ¡fego
   - Firewall controla acesso
   - Whitelist evita bloqueios falsos

4. **Escalabilidade**:
   - FÃ¡cil adicionar novos serviÃ§os via Traefik
   - Email isolado e independente

5. **ManutenÃ§Ã£o**:
   - Certificados SSL gerenciados automaticamente (Traefik)
   - Logs centralizados
   - FÃ¡cil troubleshooting

## Pontos de AtenÃ§Ã£o

âš ï¸ **NAT Reflection**: Deve estar habilitado no port forward 443 para acesso externo funcionar

âš ï¸ **Snort Whitelist**: Traefik e Carbonio devem estar na Pass List para evitar bloqueios

âš ï¸ **Ordem dos Port Forwards**: pfSense usa o primeiro port forward que corresponde (ordem importa!)

âš ï¸ **Firewall Hetzner**: Pode ter regras bloqueando portas (verificar no painel)

---

**Data**: 2025-01-14  
**Autor**: Auto Assistant - itecnologys.com

